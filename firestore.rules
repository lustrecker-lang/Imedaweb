/**
 * @fileoverview Firestore Security Rules for Prototyping.
 *
 * Core Philosophy:
 * This ruleset prioritizes rapid prototyping by focusing on authorization and skipping schema validation.
 * It assumes a basic level of trust in the client and defers complex data validation to the application code.
 * The primary goal is to prevent unauthorized data access while allowing flexible data shapes.
 *
 * Data Structure:
 * The Firestore database contains two top-level collections: `pages` and `companyProfile`.
 *  - `/pages/{pageId}` stores content for individual pages, accessible by authenticated users.
 *  - `/companyProfile/{profileId}` stores company branding information.
 *
 * Key Security Decisions:
 * - Authenticated users can read any page.
 * - Only authenticated users can create, update, or delete pages and company profiles.
 * - No user listing is allowed (potential privacy concern).
 * - Data validation is minimized to facilitate rapid iteration.
 *
 * Denormalization for Authorization:
 *  - No denormalization is needed as the rules are based solely on authentication status.
 *
 * Structural Segregation:
 *  - No segregation is needed, as there are no public vs. private versions of the same data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to the 'pages' collection.
     * @path /pages/{pageId}
     * @allow get, list: Any authenticated user can read any page.
     * @allow create, update, delete: Only authenticated users can modify pages.
     * @deny create, update, delete: Unauthenticated users cannot modify pages.
     * @principle Allows authenticated users to manage page content.
     */
    match /pages/{pageId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Controls access to the 'companyProfile' collection.
     * @path /companyProfile/{profileId}
     * @allow get, list: Any authenticated user can read any company profile.
     * @allow create, update, delete: Only authenticated users can modify company profiles.
     * @deny create, update, delete: Unauthenticated users cannot modify company profiles.
     * @principle Allows authenticated users to manage company branding.
     */
    match /companyProfile/{profileId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    //------------------- Helper functions -----------------------

    /**
     * @description Checks if the user is signed in.
     * @return {bool} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }
  }
}