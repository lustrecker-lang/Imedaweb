/**
 * @fileoverview Firestore Security Rules for Prototyping.
 *
 * Core Philosophy:
 * This ruleset prioritizes rapid prototyping by focusing on authorization and access control, while relaxing data validation.
 * All authenticated users are treated as administrators.
 *
 * Data Structure:
 * The database stores company profiles and page content.
 * - `/companyProfile/{profileId}`: Stores company branding information.
 * - `/pages/{pageId}`: Stores the content for specific pages.
 * - `/leads/{leadId}`: Stores lead data.
 *
 * Key Security Decisions:
 * - All authenticated users can read and write all data.
 * - Only the creator of a document can update or delete it.
 * - Data validation is minimal, focusing on relational integrity (ownership) rather than data types or schema adherence.
 *
 * Denormalization for Authorization:
 * Each document in `/pages`, `/companyProfile`, and `/leads` is expected to have a `userId` field indicating the owner. This is used for write access control.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Helper Functions
     */
    function isSignedIn() {
      return request.auth != null;
    }

    // Checks if the requesting user is the owner of the document based on the 'userId' field.
    function isOwner() {
      return request.auth.uid == resource.data.userId;
    }


    /**
     * @description Controls access to the pages collection.
     * @path /pages/{pageId}
     * @allow (get, list) Any signed-in user can read any page.
     * @allow (create) Any signed-in user can create a page if the `userId` field matches their UID.
     * @allow (update, delete) Any signed-in user can update or delete a page if they are the owner (based on the `userId` field).
     * @deny (create) A user cannot create a page with a `userId` that does not match their own UID.
     * @deny (update, delete) A user cannot update or delete a page they do not own.
     * @principle Enforces document ownership for writes.
     */
    match /pages/{pageId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isSignedIn() && isOwner();
    }

    /**
     * @description Controls access to the companyProfile collection.
     * @path /companyProfile/{profileId}
     * @allow (get, list) Any signed-in user can read any profile.
     * @allow (create) Any signed-in user can create a profile if the `userId` field matches their UID.
     * @allow (update, delete) Any signed-in user can update or delete a profile if they are the owner (based on the `userId` field).
     * @deny (create) A user cannot create a profile with a `userId` that does not match their own UID.
     * @deny (update, delete) A user cannot update or delete a profile they do not own.
     * @principle Enforces document ownership for writes.
     */
    match /companyProfile/{profileId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isSignedIn() && isOwner();
    }
    
    /**
     * @description Controls access to the leads collection.
     * @path /leads/{leadId}
     * @allow (get, list) Any signed-in user can read any lead.
     * @allow (create) Any signed-in user can create a lead if the `userId` field matches their UID.
     * @allow (update, delete) Only the original creator can update or delete a lead.
     * @deny (create) A user cannot create a lead with a `userId` that does not match their own UID.
     * @deny (update, delete) A user cannot update or delete a lead they do not own.
     * @principle Any signed-in user is an admin and can access leads.
     */
    match /leads/{leadId} {
      // Allow any signed-in user to read the list of leads. THIS FIXES YOUR ERROR.
      allow get, list: if isSignedIn();
      
      // Allow any signed-in user to create a lead, ensuring they set their own userId.
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;

      // Only allow the original creator to update or delete a lead.
      allow update, delete: if isSignedIn() && isOwner();
    }
  }
}