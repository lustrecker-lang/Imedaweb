/**
 * @file Firestore Security Rules for IMEDA Website Project
 * @description This ruleset enforces a role-based access control model for managing admin users and home page content.
 *
 * Data Structure:
 * - `/roles_admin/{adminId}`: Stores admin user IDs. The existence of a document at this path indicates that the user is an admin.
 * - `/homePageContent/{homePageContentId}`: Stores the content for the home page.
 *
 * Key Security Decisions:
 * - Only authenticated users can be admins.
 * - Only admins can create, update, or delete home page content.
 * - Regular users have no access to the home page content management system.
 *
 * Authorization Independence:
 *   Admin status is determined by the existence of a document in the `/roles_admin/{adminId}` collection. This allows rules to verify admin status efficiently without extra `get()` calls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the current user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is an admin by verifying the existence of their ID in the /roles_admin collection.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    match /roles_admin/{adminId} {
      /**
       * @description Allows creating an admin role if the authenticated user's ID matches the document ID.
       * @path /roles_admin/{adminId}
       * @allow (create) User with UID "user_abc" creates a document with ID "user_abc" under /roles_admin.
       * @deny (create) User with UID "user_abc" attempts to create a document with ID "different_user" under /roles_admin.
       * @principle Enforces self-creation for admin roles based on authenticated user ID.
       */
      allow create: if isSignedIn() && request.auth.uid == adminId;

      /**
       * @description Allows getting an admin role if the user is an admin.
       * @path /roles_admin/{adminId}
       * @allow (get) Admin user with ID "admin_abc" gets their own admin role document.
       * @deny (get) Non-admin user attempts to get an admin role document.
       * @principle Restricts read access to admin roles to only admin users.
       */
      allow get: if isSignedIn() && isAdmin();

      /**
       * @description Allows listing admin roles if the user is an admin.
       * @path /roles_admin/{adminId}
       * @allow (list) Admin user lists the admin roles collection.
       * @deny (list) Non-admin user attempts to list the admin roles collection.
       * @principle Restricts list access to admin roles to only admin users.
       */
      allow list: if isSignedIn() && isAdmin();

      /**
       * @description Allows updating an existing admin role if the user is an admin and matches the document ID.
       * @path /roles_admin/{adminId}
       * @allow (update) Admin user with ID "admin_abc" updates their own admin role document.
       * @deny (update) Non-admin user attempts to update an admin role document.
       * @principle Enforces that only the admin user can update their own role.
       */
      allow update: if isSignedIn() && isAdmin() && request.auth.uid == adminId && resource != null;

      /**
       * @description Allows deleting an existing admin role if the user is an admin and matches the document ID.
       * @path /roles_admin/{adminId}
       * @allow (delete) Admin user with ID "admin_abc" deletes their own admin role document.
       * @deny (delete) Non-admin user attempts to delete an admin role document.
       * @principle Enforces that only the admin user can delete their own role.
       */
      allow delete: if isSignedIn() && isAdmin() && request.auth.uid == adminId && resource != null;
    }

    match /homePageContent/{homePageContentId} {
      /**
       * @description Allows admins to create home page content.
       * @path /homePageContent/{homePageContentId}
       * @allow (create) Admin user creates a new home page content document.
       * @deny (create) Non-admin user attempts to create a home page content document.
       * @principle Restricts creation of home page content to admin users.
       */
      allow create: if isSignedIn() && isAdmin();

      /**
       * @description Allows anyone to read (get) home page content.
       * @path /homePageContent/{homePageContentId}
       * @allow (get) Any user can get a home page content document.
       * @deny (get) N/A
       * @principle Allows public read access to home page content.
       */
      allow get: if true;

      /**
       * @description Allows anyone to list home page content.
       * @path /homePageContent/{homePageContentId}
       * @allow (list) Any user can list home page content documents.
       * @deny (list) N/A
       * @principle Allows public list access to home page content.
       */
      allow list: if true;

      /**
       * @description Allows admins to update home page content, but only if the document exists.
       * @path /homePageContent/{homePageContentId}
       * @allow (update) Admin user updates an existing home page content document.
       * @deny (update) Non-admin user attempts to update a home page content document.
       * @principle Restricts updates of home page content to admin users.
       */
      allow update: if isSignedIn() && isAdmin() && resource != null;

      /**
       * @description Allows admins to delete home page content, but only if the document exists.
       * @path /homePageContent/{homePageContentId}
       * @allow (delete) Admin user deletes an existing home page content document.
       * @deny (delete) Non-admin user attempts to delete a home page content document.
       * @principle Restricts deletion of home page content to admin users.
       */
      allow delete: if isSignedIn() && isAdmin() && resource != null;
    }
  }
}